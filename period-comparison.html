<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时段对比</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            padding: 0;
        }
        /* 顶部导航栏 */
        .navbar {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #3498db;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
        }
        .nav-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .nav-menu {
            display: flex;
            gap: 5px;
            list-style: none;
        }
        .nav-menu > li {
            position: relative;
        }
        .nav-menu > li > a {
            display: block;
            padding: 10px 20px;
            color: #555;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 15px;
            position: relative;
        }
        .nav-menu > li > a:hover {
            background: #f0f0f0;
            color: #3498db;
        }
        .nav-menu > li > a.active {
            background: #3498db;
            color: white;
        }
        .nav-menu > li.has-submenu > a::after {
            content: '▼';
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
        }
        /* 下拉菜单 */
        .submenu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
            margin-top: 5px;
            padding: 5px 0;
        }
        /* 用户菜单 */
        .user-menu {
            position: relative;
            margin-left: 20px;
        }
        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #495057;
        }
        .user-menu-btn:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
            margin-top: 8px;
            padding: 8px 0;
        }
        .user-menu:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 10px 16px;
            color: #495057;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .user-dropdown a:hover {
            background: #f8f9fa;
            color: #3498db;
            padding-left: 20px;
        }
        .user-dropdown .divider {
            height: 1px;
            background: #e9ecef;
            margin: 8px 0;
        }
        .nav-menu > li:hover .submenu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .submenu li {
            list-style: none;
        }
        .submenu li a {
            display: block;
            padding: 10px 20px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .submenu li a:hover {
            background: #f0f0f0;
            color: #3498db;
            padding-left: 25px;
        }
        .submenu li a.active {
            background: #3498db;
            color: white;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
            font-size: 24px;
        }
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
            font-size: 13px;
        }
        select, input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }
        button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .period-management {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .period-list {
            margin-top: 10px;
        }
        .period-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        .period-item input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .chart-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-left {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .chart-right {
            width: 400px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .chart-right .data-table {
            overflow-x: auto;
            white-space: nowrap;
            display: block;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        .chart-type-selector {
            display: flex;
            gap: 8px;
        }
        .chart-type-btn {
            padding: 5px 10px;
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .chart-type-btn:hover {
            background: #d5dbdb;
        }
        .chart-type-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        /* 时间轴控制 */
        .timeline-control {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .timeline-slider-container {
            position: relative;
            width: 100%;
            height: 6px;
            margin: 4px 0;
        }
        .timeline-slider-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
        }
        .timeline-slider-range {
            position: absolute;
            height: 6px;
            background: #3498db;
            border-radius: 3px;
        }
        .timeline-slider-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            top: -5px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: #555;
            font-size: 12px;
        }
        .export-buttons {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        /* 数据列表 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }
        .data-table tr:hover {
            background: #f5f5f5;
        }
        /* 分页 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .pagination button {
            padding: 6px 12px;
            background: white;
            color: #3498db;
            border: 1px solid #3498db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .pagination button:hover:not(:disabled) {
            background: #3498db;
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .page-info {
            color: #555;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <div class="nav-logo-icon">AQ</div>
                <span>空气质量分析服务系统</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html">首页</a></li>
                <li><a href="air-quality-query.html">空气质量查询</a></li>
                <li class="has-submenu">
                    <a href="#">时空变化分析</a>
                    <ul class="submenu">
                        <li><a href="period-comparison.html" class="active">时段对比</a></li>
                        <li><a href="station-comparison.html">站点对比</a></li>
                        <li><a href="time-anomaly.html">时间距平</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">污染物特征分析</a>
                    <ul class="submenu">
                        <li><a href="pollutant-correlation.html">污染物关联性分析</a></li>
                        <li><a href="pollutant-calendar.html">污染物日历分析</a></li>
                        <li><a href="pollutant-weekday.html">污染物星期分析</a></li>
                        <li><a href="pollutant-hourly.html">污染物小时分析</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">达标压力测算</a>
                    <ul class="submenu">
                        <li><a href="compliance-target.html">达标目标</a></li>
                        <li><a href="compliance-analysis.html">达标分析</a></li>
                    </ul>
                </li>
            </ul>
            
            <!-- 用户菜单 -->
            <div class="user-menu" id="userMenu">
                <div class="user-menu-btn">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">管理员</span>
                </div>
                <div class="user-dropdown">
                    <a href="profile.html">个人中心</a>
                    <div class="divider"></div>
                    <a href="#" onclick="logout()">退出登录</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <h1>时段对比</h1>
        
        <!-- 查询条件 -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>站点：</label>
                    <select id="stationSelect">
                        <option value="station1">鼓浪屿海滨空气监测站</option>
                        <option value="station2">莲前大道空气质量监测站</option>
                        <option value="station3">筼筜湖生态监测站</option>
                        <option value="station4">五缘湾湿地空气监测站</option>
                        <option value="station5">枋湖工业片区空气质量监测站</option>
                        <option value="station6">杏林湾新城空气监测站</option>
                        <option value="station7">厦门北站交通枢纽监测站</option>
                        <option value="station8">嵩屿码头空气监测站</option>
                        <option value="station9">海沧生物医药园监测站</option>
                        <option value="station10">同安工业集中区空气监测站</option>
                        <option value="station11">翔安机场片区空气质量监测站</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>监测指标：</label>
                    <select id="indicatorType" onchange="onIndicatorTypeChange()">
                        <option value="pollutant">污染因子</option>
                        <option value="meteorological">气象因子</option>
                    </select>
                </div>
                <div class="filter-item" id="pollutantIndicatorSelect" style="display: block;">
                    <label>污染因子：</label>
                    <select id="pollutantIndicator">
                        <option value="PM25">PM2.5</option>
                        <option value="PM10">PM10</option>
                        <option value="O3_8h">O₃-8h</option>
                        <option value="NO2">NO₂</option>
                        <option value="SO2">SO₂</option>
                        <option value="CO">CO</option>
                        <option value="AQI">AQI</option>
                    </select>
                </div>
                <div class="filter-item" id="meteorologicalIndicatorSelect" style="display: none;">
                    <label>气象因子：</label>
                    <select id="meteorologicalIndicator">
                        <option value="windDirection">风向</option>
                        <option value="windSpeed">风速</option>
                        <option value="temperature">温度</option>
                        <option value="humidity">相对湿度</option>
                        <option value="pressure">大气压</option>
                        <option value="precipitation">降水量</option>
                    </select>
                </div>
                <button onclick="updateChart()" style="margin-left: auto;">查询</button>
            </div>
        </div>

        <!-- 时段管理 -->
        <div class="period-management">
            <h3 style="font-size: 14px; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">对比时段管理（最多10个时段）</h3>
            <div class="period-list" id="periodList"></div>
            <button class="btn-success" onclick="addPeriod()" id="addBtn">添加时段</button>
        </div>

        <!-- 图表和数据表格左右布局 -->
        <div class="chart-layout">
            <!-- 左侧图表 -->
            <div class="chart-left">
                <div class="chart-header">
                    <div class="chart-title">多时段对比分析结果</div>
                </div>
                <canvas id="comparisonChart"></canvas>
                <div class="timeline-control">
                    <div class="timeline-slider-container">
                        <div class="timeline-slider-track"></div>
                        <div id="timelineSliderRange" class="timeline-slider-range"></div>
                        <div id="timelineSliderHandleLeft" class="timeline-slider-handle"></div>
                        <div id="timelineSliderHandleRight" class="timeline-slider-handle"></div>
                    </div>
                    <div class="timeline-labels">
                        <span id="timelineStart">开始</span>
                        <span id="timelineEnd">结束</span>
                    </div>
                </div>
            </div>

            <!-- 右侧数据表格 -->
            <div class="chart-right">
                <div class="chart-header">
                    <div class="chart-title">数据列表</div>
                </div>
                <div class="export-buttons" id="exportButtons"></div>
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        let comparisonChart;
        let periods = [];
        let allPeriodData = {};
        let currentTimeRange = { start: 0, end: 100 };
        let currentPage = 1;
        const pageSize = 15; // 修改为每页15条

        // 监测指标类型切换
        function onIndicatorTypeChange() {
            const indicatorType = document.getElementById('indicatorType').value;
            if (indicatorType === 'pollutant') {
                document.getElementById('pollutantIndicatorSelect').style.display = 'block';
                document.getElementById('meteorologicalIndicatorSelect').style.display = 'none';
            } else {
                document.getElementById('pollutantIndicatorSelect').style.display = 'none';
                document.getElementById('meteorologicalIndicatorSelect').style.display = 'block';
            }
            // 清空时段数据，重新生成
            periods = [];
            allPeriodData = {};
            document.getElementById('periodList').innerHTML = '';
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            document.getElementById('tableBody').innerHTML = '';
        }

        // 生成演示数据
        function generatePeriodData(startDate, endDate, periodName) {
            const data = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const indicatorType = document.getElementById('indicatorType').value;
            const stationId = document.getElementById('stationSelect').value;
            
            // 为不同站点生成略有差异的数据
            const stationOffset = parseInt(stationId.replace('station', '')) * 3;
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                const seasonalFactor = Math.sin(dayOfYear / 365 * Math.PI * 2);
                
                const item = {
                    date: dateStr,
                    station: stationId
                };
                
                if (indicatorType === 'pollutant') {
                    const indicator = document.getElementById('pollutantIndicator').value;
                    
                    // 根据用户要求调整各污染物的基准值和波动范围
                    item.PM25 = Math.max(0, Math.round(12 + (Math.random() - 0.5) * 10 + stationOffset)); // PM2.5调整在12之间波动，上下波动不大于5
                    item.PM10 = Math.max(0, Math.round(10 + (Math.random() - 0.5) * 20 + stationOffset)); // PM10调整在10之间波动，上下波动不大于10
                    item.O3_8h = Math.max(0, Math.round(10 + (Math.random() - 0.5) * 10 + stationOffset)); // O3-8h调整在10之间，上下变幅5
                    item.O3 = Math.max(0, Math.round(10 + (Math.random() - 0.5) * 10 + stationOffset)); // O3调整在10之间，上下变幅5
                    item.NO2 = Math.max(0, Math.round(1 + (Math.random() - 0.5) * 2 + stationOffset)); // NO2调整在1之间波动，上下变幅不超过1
                    item.SO2 = 1 + stationOffset; // SO2调整为1
                    item.CO = Math.max(0, Math.round((3 + (Math.random() - 0.5) * 2) * 10) / 10); // CO调整在3之间波动，上下变幅1
                    item.AQI = 0;
                    
                    // 计算AQI，取同一时段各污染物最大值
                    const aqi = Math.max(
                        calculateAQI(item.PM25, 'PM25'),
                        calculateAQI(item.PM10, 'PM10'),
                        calculateAQI(item.O3_8h, 'O3'),
                        calculateAQI(item.O3, 'O3'),
                        calculateAQI(item.NO2, 'NO2'),
                        calculateAQI(item.SO2, 'SO2'),
                        calculateAQI(item.CO, 'CO')
                    );
                    item.AQI = Math.round(aqi);
                } else {
                    // 气象因子
                    item.windDirection = Math.round(Math.random() * 360);
                    item.windSpeed = Math.max(0, Math.round((2 + Math.random() * 4) * 10) / 10);
                    item.temperature = Math.round((5 + Math.random() * 15) * 10) / 10;
                    item.humidity = Math.round(50 + Math.random() * 40);
                    item.pressure = Math.round(1010 + (Math.random() - 0.5) * 20);
                    item.precipitation = Math.round(Math.random() * 5 * 10) / 10;
                }
                
                data.push(item);
            }
            
            return data;
        }

        function calculateAQI(value, type) {
            const breakpoints = {
                PM25: [[0,50,0,35],[50,100,35,75],[100,150,75,115],[150,200,115,150],[200,300,150,250],[300,500,250,500]],
                PM10: [[0,50,0,50],[50,100,50,150],[100,150,150,250],[150,200,250,350],[200,300,350,420],[300,500,420,600]],
                O3: [[0,50,0,100],[50,100,100,160],[100,150,160,215],[150,200,215,265],[200,300,265,800],[300,500,800,1200]],
                NO2: [[0,50,0,40],[50,100,40,80],[100,150,80,180],[150,200,180,280],[200,300,280,565],[300,500,565,750]],
                SO2: [[0,50,0,50],[50,100,50,150],[100,150,150,475],[150,200,475,800],[200,300,800,1600],[300,500,1600,2620]],
                CO: [[0,50,0,2],[50,100,2,4],[100,150,4,14],[150,200,14,24],[200,300,24,36],[300,500,36,60]]
            };
            
            const bp = breakpoints[type] || breakpoints.PM25;
            for (let i = 0; i < bp.length; i++) {
                if (value >= bp[i][0] && value <= bp[i][1]) {
                    const aqi = ((bp[i][3] - bp[i][2]) / (bp[i][1] - bp[i][0])) * (value - bp[i][0]) + bp[i][2];
                    return aqi;
                }
            }
            return 0;
        }

        function addPeriod() {
            if (periods.length >= 10) {
                alert('最多只能添加10个时段');
                return;
            }
            
            const periodId = 'period_' + Date.now();
            const period = {
                id: periodId,
                name: `时段${periods.length + 1}`,
                startDate: '2024-01-01',
                endDate: '2024-01-31'
            };
            
            periods.push(period);
            renderPeriodList();
            updateChart();
            updateTable();
        }

        function removePeriod(id) {
            periods = periods.filter(p => p.id !== id);
            delete allPeriodData[id];
            renderPeriodList();
            updateChart();
            updateTable();
        }

        function updatePeriod(id, field, value) {
            const period = periods.find(p => p.id === id);
            if (period) {
                period[field] = value;
                if (field === 'startDate' || field === 'endDate') {
                    // 重新生成数据
                    allPeriodData[id] = generatePeriodData(period.startDate, period.endDate, period.name);
                    updateChart();
                    updateTable();
                }
            }
        }

        function renderPeriodList() {
            const list = document.getElementById('periodList');
            list.innerHTML = '';
            
            periods.forEach(period => {
                const item = document.createElement('div');
                item.className = 'period-item';
                item.innerHTML = `
                    <input type="text" value="${period.name}" onchange="updatePeriod('${period.id}', 'name', this.value)" placeholder="时段名称">
                    <label>开始日期：</label>
                    <input type="date" value="${period.startDate}" onchange="updatePeriod('${period.id}', 'startDate', this.value)">
                    <label>结束日期：</label>
                    <input type="date" value="${period.endDate}" onchange="updatePeriod('${period.id}', 'endDate', this.value)">
                    <button class="btn-danger" onclick="removePeriod('${period.id}')">删除</button>
                `;
                list.appendChild(item);
            });
            
            document.getElementById('addBtn').disabled = periods.length >= 10;
        }

        function updateChart() {
            // 为每个时段生成数据
            periods.forEach(period => {
                if (!allPeriodData[period.id]) {
                    allPeriodData[period.id] = generatePeriodData(period.startDate, period.endDate, period.name);
                }
            });
            
            // 更新时间轴标签
            const labelStart = document.getElementById('timelineStart');
            const labelEnd = document.getElementById('timelineEnd');
            if (periods.length > 0) {
                let earliestStart = null;
                let latestEnd = null;
                
                periods.forEach(period => {
                    const startDate = new Date(period.startDate);
                    const endDate = new Date(period.endDate);
                    
                    if (!earliestStart || startDate < earliestStart) {
                        earliestStart = startDate;
                    }
                    if (!latestEnd || endDate > latestEnd) {
                        latestEnd = endDate;
                    }
                });
                
                if (earliestStart && latestEnd) {
                    labelStart.textContent = earliestStart.toLocaleDateString('zh-CN');
                    labelEnd.textContent = latestEnd.toLocaleDateString('zh-CN');
                }
            }
            
            if (periods.length === 0) {
                if (comparisonChart) {
                    comparisonChart.destroy();
                }
                return;
            }
            
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            const indicatorType = document.getElementById('indicatorType').value;
            let indicator, indicatorName, unit;
            
            if (indicatorType === 'pollutant') {
                indicator = document.getElementById('pollutantIndicator').value;
                const names = {
                    PM25: 'PM2.5',
                    PM10: 'PM10',
                    O3_8h: 'O₃-8h',
                    NO2: 'NO₂',
                    SO2: 'SO₂',
                    CO: 'CO',
                    AQI: 'AQI'
                };
                indicatorName = names[indicator] || indicator;
                unit = indicator === 'CO' ? 'mg/m³' : indicator === 'AQI' ? '' : 'μg/m³';
            } else {
                indicator = document.getElementById('meteorologicalIndicator').value;
                const names = {
                    windDirection: '风向',
                    windSpeed: '风速',
                    temperature: '温度',
                    humidity: '相对湿度',
                    pressure: '大气压',
                    precipitation: '降水量'
                };
                indicatorName = names[indicator] || indicator;
                unit = indicator === 'windSpeed' ? 'm/s' : 
                       indicator === 'temperature' ? '℃' : 
                       indicator === 'humidity' ? '%' : 
                       indicator === 'pressure' ? 'hPa' : 
                       indicator === 'precipitation' ? 'mm' : '°';
            }
            
            // 合并所有时段的数据
            const allDates = new Set();
            periods.forEach(period => {
                allPeriodData[period.id].forEach(item => allDates.add(item.date));
            });
            const sortedDates = Array.from(allDates).sort();
            const filteredDates = filterDatesByRange(sortedDates);
            
            const colors = ['#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b'];
            
            const datasets = periods.map((period, idx) => {
                const data = filteredDates.map(date => {
                    const item = allPeriodData[period.id].find(d => d.date === date);
                    return item ? item[indicator] : null;
                });
                
                return {
                    label: period.name,
                    data: data,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '20',
                    tension: 0.4,
                    fill: false
                };
            });
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    height: 400,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: `${indicatorName}${unit ? ` (${unit})` : ''}` }
                        },
                        x: {
                            title: { display: true, text: '日期' },
                            ticks: { maxRotation: 45, minRotation: 45 }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });
        }

        function filterDatesByRange(dates) {
            const total = dates.length;
            const startIdx = Math.floor(total * currentTimeRange.start / 100);
            const endIdx = Math.min(Math.floor(total * currentTimeRange.end / 100), total);
            return dates.slice(startIdx, endIdx);
        }

        function initTimelineSlider() {
            const sliderContainer = document.querySelector('.timeline-slider-container');
            const sliderRange = document.getElementById('timelineSliderRange');
            const handleLeft = document.getElementById('timelineSliderHandleLeft');
            const handleRight = document.getElementById('timelineSliderHandleRight');
            const labelStart = document.getElementById('timelineStart');
            const labelEnd = document.getElementById('timelineEnd');
            
            let isDraggingLeft = false;
            let isDraggingRight = false;
            
            // 更新时间轴标签为实际的查询时间范围
            function updateTimelineLabels() {
                if (periods.length > 0) {
                    // 获取所有时段的最早开始时间和最晚结束时间
                    let earliestStart = null;
                    let latestEnd = null;
                    
                    periods.forEach(period => {
                        const startDate = new Date(period.startDate);
                        const endDate = new Date(period.endDate);
                        
                        if (!earliestStart || startDate < earliestStart) {
                            earliestStart = startDate;
                        }
                        if (!latestEnd || endDate > latestEnd) {
                            latestEnd = endDate;
                        }
                    });
                    
                    if (earliestStart && latestEnd) {
                        labelStart.textContent = earliestStart.toLocaleDateString('zh-CN');
                        labelEnd.textContent = latestEnd.toLocaleDateString('zh-CN');
                    }
                }
            }
            
            function updateSlider() {
                sliderRange.style.left = currentTimeRange.start + '%';
                sliderRange.style.width = (currentTimeRange.end - currentTimeRange.start) + '%';
                handleLeft.style.left = currentTimeRange.start + '%';
                handleRight.style.left = currentTimeRange.end + '%';
                // 更新标签显示
                updateTimelineLabels();
            }
            
            function setTimelineRange(start, end) {
                currentTimeRange.start = Math.max(0, Math.min(100, start));
                currentTimeRange.end = Math.max(0, Math.min(100, end));
                if (currentTimeRange.start >= currentTimeRange.end) {
                    currentTimeRange.start = Math.max(0, currentTimeRange.end - 10);
                }
                updateSlider();
                updateChart();
                updateTable();
            }
            
            function getPosition(e) {
                const rect = sliderContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width * 100;
                return pos;
            }
            
            handleLeft.addEventListener('mousedown', () => {
                isDraggingLeft = true;
            });
            
            handleRight.addEventListener('mousedown', () => {
                isDraggingRight = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDraggingLeft) {
                    const pos = getPosition(e);
                    setTimelineRange(pos, currentTimeRange.end);
                } else if (isDraggingRight) {
                    const pos = getPosition(e);
                    setTimelineRange(currentTimeRange.start, pos);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDraggingLeft = false;
                isDraggingRight = false;
            });
            
            // 初始化
            updateSlider();
        }

        // 更新数据表格
        function updateTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const pagination = document.getElementById('pagination');
            const exportButtons = document.getElementById('exportButtons');
            
            if (periods.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '';
                pagination.innerHTML = '';
                if (exportButtons) exportButtons.innerHTML = '';
                return;
            }
            
            const indicatorType = document.getElementById('indicatorType').value;
            let indicator, indicatorName;
            
            if (indicatorType === 'pollutant') {
                indicator = document.getElementById('pollutantIndicator').value;
                const names = {
                    PM25: 'PM2.5',
                    PM10: 'PM10',
                    O3_8h: 'O₃-8h',
                    NO2: 'NO₂',
                    SO2: 'SO₂',
                    CO: 'CO',
                    AQI: 'AQI'
                };
                indicatorName = names[indicator] || indicator;
            } else {
                indicator = document.getElementById('meteorologicalIndicator').value;
                const names = {
                    windDirection: '风向',
                    windSpeed: '风速',
                    temperature: '温度',
                    humidity: '相对湿度',
                    pressure: '大气压',
                    precipitation: '降水量'
                };
                indicatorName = names[indicator] || indicator;
            }
            
            // 合并所有日期
            const allDates = new Set();
            periods.forEach(period => {
                allPeriodData[period.id].forEach(item => allDates.add(item.date));
            });
            const sortedDates = Array.from(allDates).sort();
            const filteredDates = filterDatesByRange(sortedDates);
            
            // 生成表头
            thead.innerHTML = `<tr><th>日期</th>${periods.map(p => `<th>${p.name}</th>`).join('')}</tr>`;
            
            // 分页 - 修改为每页15条
            const totalPages = Math.ceil(filteredDates.length / pageSize);
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageData = filteredDates.slice(startIdx, endIdx);
            
            tbody.innerHTML = '';
            pageData.forEach(date => {
                const row = document.createElement('tr');
                let rowHtml = `<td>${date}</td>`;
                periods.forEach(period => {
                    const item = allPeriodData[period.id]?.find(d => d.date === date);
                    const value = item ? item[indicator] : '-';
                    rowHtml += `<td>${value !== '-' ? (typeof value === 'number' ? value.toFixed(2) : value) : '-'}</td>`;
                });
                row.innerHTML = rowHtml;
                tbody.appendChild(row);
            });
            
            // 分页控件
            pagination.innerHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>
                <span class="page-info">第 ${currentPage} / ${totalPages} 页，共 ${filteredDates.length} 条</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>
            `;
            
            // 显示导出按钮
            if (exportButtons) {
                exportButtons.innerHTML = `
                    <button onclick="exportImage()">导出图片</button>
                    <button onclick="exportCSV()">导出CSV</button>
                `;
            }
        }

        function changePage(page) {
            const allDates = new Set();
            periods.forEach(period => {
                allPeriodData[period.id].forEach(item => allDates.add(item.date));
            });
            const sortedDates = Array.from(allDates).sort();
            const filteredDates = filterDatesByRange(sortedDates);
            const totalPages = Math.ceil(filteredDates.length / pageSize);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updateTable();
            }
        }

        function exportImage() {
            if (comparisonChart) {
                const url = comparisonChart.toBase64Image();
                const link = document.createElement('a');
                link.download = '时段对比分析结果.png';
                link.href = url;
                link.click();
            }
        }

        function exportCSV() {
            const indicatorType = document.getElementById('indicatorType').value;
            let indicator, indicatorName;
            
            if (indicatorType === 'pollutant') {
                indicator = document.getElementById('pollutantIndicator').value;
                const names = {
                    PM25: 'PM2.5',
                    PM10: 'PM10',
                    O3_8h: 'O₃-8h',
                    NO2: 'NO₂',
                    SO2: 'SO₂',
                    CO: 'CO',
                    AQI: 'AQI'
                };
                indicatorName = names[indicator] || indicator;
            } else {
                indicator = document.getElementById('meteorologicalIndicator').value;
                const names = {
                    windDirection: '风向',
                    windSpeed: '风速',
                    temperature: '温度',
                    humidity: '相对湿度',
                    pressure: '大气压',
                    precipitation: '降水量'
                };
                indicatorName = names[indicator] || indicator;
            }
            
            let csv = '日期';
            periods.forEach(period => {
                csv += `,${period.name}(${indicatorName})`;
            });
            csv += '\n';
            
            const allDates = new Set();
            periods.forEach(period => {
                allPeriodData[period.id].forEach(item => allDates.add(item.date));
            });
            const sortedDates = Array.from(allDates).sort();
            
            sortedDates.forEach(date => {
                csv += date;
                periods.forEach(period => {
                    const item = allPeriodData[period.id]?.find(d => d.date === date);
                    const value = item ? item[indicator] : '';
                    csv += `,${value !== '' ? (typeof value === 'number' ? value.toFixed(2) : value) : ''}`;
                });
                csv += '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '时段对比分析结果.csv';
            link.click();
        }

        // 初始化
        window.onload = function() {
            // 添加默认时段
            addPeriod();
            // 初始化时间轴滑块
            initTimelineSlider();
        };
    </script>
</body>
</html>

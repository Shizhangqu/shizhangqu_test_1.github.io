<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>污染物星期分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            padding: 0;
        }
        /* 顶部导航栏 */
        .navbar {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #3498db;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
        }
        .nav-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .nav-menu {
            display: flex;
            gap: 5px;
            list-style: none;
        }
        .nav-menu > li {
            position: relative;
        }
        .nav-menu > li > a {
            display: block;
            padding: 10px 20px;
            color: #555;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 15px;
            position: relative;
        }
        .nav-menu > li > a:hover {
            background: #f0f0f0;
            color: #3498db;
        }
        .nav-menu > li > a.active {
            background: #3498db;
            color: white;
        }
        .nav-menu > li.has-submenu > a::after {
            content: '▼';
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
        }
        /* 下拉菜单 */
        .submenu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
            margin-top: 5px;
            padding: 5px 0;
        }
        .nav-menu > li:hover .submenu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .submenu li {
            list-style: none;
        }
        .submenu li a {
            display: block;
            padding: 10px 20px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .submenu li a:hover {
            background: #f0f0f0;
            color: #3498db;
            padding-left: 25px;
        }
        .submenu li a.active {
            background: #3498db;
            color: white;
        }
        /* 用户菜单 */
        .user-menu {
            position: relative;
            margin-left: 20px;
        }
        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #495057;
        }
        .user-menu-btn:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
            margin-top: 8px;
            padding: 8px 0;
        }
        .user-menu:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 10px 16px;
            color: #495057;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }
        .user-dropdown a:hover {
            background: #f8f9fa;
            color: #3498db;
            padding-left: 20px;
        }
        .user-dropdown .divider {
            height: 1px;
            background: #e9ecef;
            margin: 8px 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
            font-size: 24px;
        }
        /* 缩小查询条件版面 */
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
            font-size: 13px;
        }
        select, input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }
        button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .pollutant-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .pollutant-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .station-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .station-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .period-management {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .period-list {
            margin-top: 10px;
        }
        .period-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 13px;
        }
        .period-item input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .week-indicator {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        /* 图表布局 */
        .chart-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-left {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .chart-right {
            width: 400px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .chart-wrapper {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        /* 时间轴控制 */
        .timeline-control {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .timeline-slider-container {
            position: relative;
            width: 100%;
            height: 6px;
            margin: 4px 0;
        }
        .timeline-slider-track {
            position: absolute;
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
        }
        .timeline-slider-range {
            position: absolute;
            height: 6px;
            background: #3498db;
            border-radius: 3px;
        }
        .timeline-slider-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            top: -5px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: #555;
            font-size: 12px;
        }
        
        /* 下拉多选框样式 */
        .dropdown-multiselect {
            position: relative;
            min-width: 350px;
            max-width: 500px;
        }
        
        .dropdown-header {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            transition: border-color 0.3s;
        }
        
        .dropdown-header:hover {
            border-color: #3498db;
        }
        
        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.3s;
            color: #666;
        }
        
        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            width: 350px;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .dropdown-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item input[type="checkbox"] {
            margin: 0;
        }
        
        .dropdown-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: #e9ecef;
            margin: 4px 0;
        }
        
        /* 数据列表 */
        .data-table-section {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .data-table-section .chart-header {
            margin-bottom: 15px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
            overflow-x: auto;
            white-space: nowrap;
            display: block;
        }
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            min-width: 100px;
        }
        .data-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover {
            background: #f5f5f5;
        }
        /* 分页 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .pagination button {
            padding: 6px 12px;
            background: white;
            color: #3498db;
            border: 1px solid #3498db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .pagination button:hover:not(:disabled) {
            background: #3498db;
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .page-info {
            color: #555;
            font-size: 14px;
        }
        /* 导出按钮 */
        .export-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <div class="nav-logo-icon">AQ</div>
                <span>空气质量分析服务系统</span>
            </a>
            <ul class="nav-menu">
                <li><a href="index.html">首页</a></li>
                <li><a href="air-quality-query.html">空气质量查询</a></li>
                <li class="has-submenu">
                    <a href="#">时空变化分析</a>
                    <ul class="submenu">
                        <li><a href="period-comparison.html">时段对比</a></li>
                        <li><a href="station-comparison.html">站点对比</a></li>
                        <li><a href="time-anomaly.html">时间距平</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">污染物特征分析</a>
                    <ul class="submenu">
                        <li><a href="pollutant-correlation.html">污染物关联性分析</a></li>
                        <li><a href="pollutant-calendar.html">污染物日历分析</a></li>
                        <li><a href="pollutant-weekday.html" class="active">污染物星期分析</a></li>
                        <li><a href="pollutant-hourly.html">污染物小时分析</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#">达标压力测算</a>
                    <ul class="submenu">
                        <li><a href="compliance-target.html">达标目标</a></li>
                        <li><a href="compliance-analysis.html">达标分析</a></li>
                    </ul>
                </li>
            </ul>
            
            <!-- 用户菜单 -->
            <div class="user-menu" id="userMenu">
                <div class="user-menu-btn">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">管理员</span>
                </div>
                <div class="user-dropdown">
                    <a href="profile.html">个人中心</a>
                    <div class="divider"></div>
                    <a href="#" onclick="logout()">退出登录</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <h1>污染物星期分析</h1>
        
        <!-- 查询条件 -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>分析模式：</label>
                    <select id="analysisMode" onchange="onAnalysisModeChange()">
                        <option value="multiStation">多站点分析</option>
                        <option value="multiPeriod">多时段分析</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>时间类型：</label>
                    <select id="timeType">
                        <option value="hourly">小时均值</option>
                        <option value="daily">日均值</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>开始时间：</label>
                    <input type="date" id="startDate" value="2024-01-01">
                </div>
                <div class="filter-item">
                    <label>结束时间：</label>
                    <input type="date" id="endDate" value="2024-03-31">
                </div>
                <button onclick="analyze()">分析</button>
            </div>
            
            <!-- 站点选择区域 -->
            <div id="stationSelectionArea" class="filter-row">
                <div class="filter-item">
                    <label>站点选择：</label>
                    <div class="dropdown-multiselect">
                        <div class="dropdown-header" onclick="toggleStationDropdown()">
                            <span id="stationSelectedCount">选择站点...</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="dropdown-content" id="stationDropdownContent" style="display: none;">
                            <div class="dropdown-item">
                                <input type="checkbox" id="stationSelectAll" onchange="toggleStationSelectAll()">
                                <label for="stationSelectAll">全选</label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div id="stationList"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 污染物选择 -->
            <div class="filter-row">
                <div class="filter-item">
                    <label>污染物选择：</label>
                    <div class="dropdown-multiselect">
                        <div class="dropdown-header" onclick="togglePollutantDropdown()">
                            <span id="pollutantSelectedCount">选择污染物...</span>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="dropdown-content" id="pollutantDropdownContent" style="display: none;">
                            <div class="dropdown-item">
                                <input type="checkbox" id="pollutantSelectAll" onchange="togglePollutantSelectAll()">
                                <label for="pollutantSelectAll">全选</label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div id="pollutantList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 时段管理区域 -->
        <div id="periodManagementArea" class="period-management" style="display: none;">
            <h3>对比时段管理（最多10个时段）</h3>
            <div class="period-list" id="periodList"></div>
            <button class="btn-success" onclick="addPeriod()" id="addBtn">添加时段</button>
        </div>

        <!-- 图表布局 -->
        <div class="chart-layout">
            <!-- 左边折线图 -->
            <div class="chart-left">
                <div class="chart-header">
                    <div class="chart-title">污染物星期变化趋势</div>
                </div>
                <canvas id="weekdayChart"></canvas>
            </div>
            
            <!-- 右边数据列表 -->
            <div class="chart-right">
                <div class="chart-header">
                    <div class="chart-title">数据列表</div>
                    <div class="export-buttons">
                        <button onclick="exportImage()">导出图片</button>
                        <button onclick="exportCSV()">导出CSV</button>
                    </div>
                </div>
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="pagination" id="dataTablePagination"></div>
            </div>
        </div>
    </div>

    <script>
        let weekdayChart;
        let allData = {};
        let selectedPollutants = [];
        let selectedStations = [];
        let periods = [];
        
        // 站点数据（厦门地区11个监测站）
        const stations = [
            { id: 'station1', name: '鼓浪屿海滨空气监测站' },
            { id: 'station2', name: '莲前大道空气质量监测站' },
            { id: 'station3', name: '筼筜湖生态监测站' },
            { id: 'station4', name: '五缘湾湿地空气监测站' },
            { id: 'station5', name: '枋湖工业片区空气质量监测站' },
            { id: 'station6', name: '杏林湾新城空气监测站' },
            { id: 'station7', name: '厦门北站交通枢纽监测站' },
            { id: 'station8', name: '嵩屿码头空气监测站' },
            { id: 'station9', name: '海沧生物医药园监测站' },
            { id: 'station10', name: '同安工业集中区空气监测站' },
            { id: 'station11', name: '翔安机场片区空气质量监测站' }
        ];

        const pollutants = [
            { id: 'AQI', name: 'AQI' },
            { id: 'PM25', name: 'PM2.5' },
            { id: 'PM10', name: 'PM10' },
            { id: 'O3_8h', name: 'O₃-8h' },
            { id: 'NO2', name: 'NO₂' },
            { id: 'SO2', name: 'SO₂' },
            { id: 'CO', name: 'CO' }
        ];

        const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];

        // 分析模式切换
        function onAnalysisModeChange() {
            const analysisMode = document.getElementById('analysisMode').value;
            if (analysisMode === 'multiStation') {
                document.getElementById('stationSelectionArea').style.display = 'flex';
                document.getElementById('periodManagementArea').style.display = 'none';
            } else {
                document.getElementById('stationSelectionArea').style.display = 'none';
                document.getElementById('periodManagementArea').style.display = 'block';
            }
        }

        // 初始化站点选择器（下拉多选框）
        function initStationSelector() {
            const stationList = document.getElementById('stationList');
            stationList.innerHTML = '';
            stations.forEach(station => {
                const checkbox = document.createElement('div');
                checkbox.className = 'dropdown-item';
                checkbox.innerHTML = `
                    <input type="checkbox" id="station_${station.id}" onchange="updateSelectedStations()">
                    <label for="station_${station.id}">${station.name}</label>
                `;
                stationList.appendChild(checkbox);
            });
            
            // 默认只选择前两个站点
            if (stations.length >= 2) {
                document.getElementById('station_' + stations[0].id).checked = true;
                document.getElementById('station_' + stations[1].id).checked = true;
            }
            
            // 初始化选择计数
            updateSelectedStations();
        }
        
        // 切换站点下拉框显示/隐藏
        function toggleStationDropdown() {
            const dropdownContent = document.getElementById('stationDropdownContent');
            
            // 先隐藏污染物下拉框
            document.getElementById('pollutantDropdownContent').style.display = 'none';
            
            // 切换站点下拉框显示/隐藏
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        }
        
        // 切换污染物下拉框显示/隐藏
        function togglePollutantDropdown() {
            const dropdownContent = document.getElementById('pollutantDropdownContent');
            const isDisplayed = dropdownContent.style.display === 'block';
            
            // 先隐藏所有下拉框
            document.getElementById('stationDropdownContent').style.display = 'none';
            document.getElementById('pollutantDropdownContent').style.display = 'none';
            
            // 切换当前下拉框
            if (!isDisplayed) {
                dropdownContent.style.display = 'block';
            }
        }
        
        // 点击页面其他地方关闭下拉框
        document.addEventListener('click', function(event) {
            const stationDropdownButton = document.getElementById('stationDropdownButton');
            const stationDropdownContent = document.getElementById('stationDropdownContent');
            const pollutantDropdownButton = document.getElementById('pollutantDropdownButton');
            const pollutantDropdownContent = document.getElementById('pollutantDropdownContent');
            
            // 检查点击是否在站点下拉框内
            if (stationDropdownButton && stationDropdownContent && 
                !stationDropdownButton.contains(event.target) && 
                !stationDropdownContent.contains(event.target)) {
                stationDropdownContent.style.display = 'none';
            }
            
            // 检查点击是否在污染物下拉框内
            if (pollutantDropdownButton && pollutantDropdownContent && 
                !pollutantDropdownButton.contains(event.target) && 
                !pollutantDropdownContent.contains(event.target)) {
                pollutantDropdownContent.style.display = 'none';
            }
        });
        
        // 切换站点全选
        function toggleStationSelectAll() {
            const selectAll = document.getElementById('stationSelectAll');
            const checkboxes = document.querySelectorAll('#stationList input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedStations();
        }
        
        // 切换污染物全选
        function togglePollutantSelectAll() {
            const selectAll = document.getElementById('pollutantSelectAll');
            const checkboxes = document.querySelectorAll('#pollutantList input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedPollutants();
        }
        


        // 更新已选择站点数量显示
        function updateStationSelectedCount() {
            const checkboxes = document.querySelectorAll('#stationList input[type="checkbox"]:checked');
            const selectedCount = document.getElementById('stationSelectedCount');
            
            if (checkboxes.length === 0) {
                selectedCount.textContent = '选择站点...';
            } else if (checkboxes.length === stations.length) {
                selectedCount.textContent = '已选择：全选';
                document.getElementById('stationSelectAll').checked = true;
            } else {
                selectedCount.textContent = `已选择：${checkboxes.length}个站点`;
                document.getElementById('stationSelectAll').checked = false;
            }
        }
        
        // 更新已选择污染物数量显示
        function updatePollutantSelectedCount() {
            const checkboxes = document.querySelectorAll('#pollutantList input[type="checkbox"]:checked');
            const selectedCount = document.getElementById('pollutantSelectedCount');
            
            if (checkboxes.length === 0) {
                selectedCount.textContent = '选择污染物...';
            } else if (checkboxes.length === pollutants.length) {
                selectedCount.textContent = '已选择：全选';
                document.getElementById('pollutantSelectAll').checked = true;
            } else {
                selectedCount.textContent = `已选择：${checkboxes.length}个污染物`;
                document.getElementById('pollutantSelectAll').checked = false;
            }
        }
        
        // 更新选中的站点
        function updateSelectedStations() {
            selectedStations = [];
            stations.forEach(station => {
                if (document.getElementById(`station_${station.id}`).checked) {
                    selectedStations.push(station.id);
                }
            });
            updateStationSelectedCount();
        }
        
        // 更新选中的污染物
        function updateSelectedPollutants() {
            selectedPollutants = [];
            pollutants.forEach(pollutant => {
                if (document.getElementById(`poll_${pollutant.id}`).checked) {
                    selectedPollutants.push(pollutant.id);
                }
            });
            updatePollutantSelectedCount();
        }

        // 初始化污染物选择器（下拉多选框）
        function initPollutantSelector() {
            const pollutantList = document.getElementById('pollutantList');
            pollutantList.innerHTML = '';
            pollutants.forEach(pollutant => {
                const checkbox = document.createElement('div');
                checkbox.className = 'dropdown-item';
                checkbox.innerHTML = `
                    <input type="checkbox" id="poll_${pollutant.id}" onchange="updateSelectedPollutants()">
                    <label for="poll_${pollutant.id}">${pollutant.name}</label>
                `;
                pollutantList.appendChild(checkbox);
            });
            
            // 默认选择所有污染物
            pollutants.forEach(pollutant => {
                document.getElementById(`poll_${pollutant.id}`).checked = true;
            });
            
            // 初始化选择计数
            updateSelectedPollutants();
        }
        
        
        
        
        
        

        // 添加时段（参考period-comparison.html）
        function addPeriod() {
            if (periods.length >= 10) {
                alert('最多只能添加10个时段');
                return;
            }
            
            const periodId = 'period_' + Date.now();
            const period = {
                id: periodId,
                name: `时段${periods.length + 1}`,
                startDate: '2024-01-01',
                endDate: '2024-01-31'
            };
            
            periods.push(period);
            renderPeriodList();
        }

        // 渲染时段列表（参考period-comparison.html）
        function renderPeriodList() {
            const periodList = document.getElementById('periodList');
            periodList.innerHTML = '';
            
            periods.forEach((period, index) => {
                const periodItem = document.createElement('div');
                periodItem.className = 'period-item';
                periodItem.innerHTML = `
                    <div>
                        <label>时段${index + 1}：</label>
                    </div>
                    <div>
                        <input type="text" value="${period.name}" onchange="updatePeriodName('${period.id}', this.value)">
                    </div>
                    <div>
                        <label>开始：</label>
                        <input type="date" value="${period.startDate}" onchange="updatePeriodDate('${period.id}', 'start', this.value)">
                    </div>
                    <div>
                        <label>结束：</label>
                        <input type="date" value="${period.endDate}" onchange="updatePeriodDate('${period.id}', 'end', this.value)">
                    </div>
                    <button class="btn-danger" onclick="removePeriod('${period.id}')">删除</button>
                `;
                periodList.appendChild(periodItem);
            });
        }

        // 更新时段名称
        function updatePeriodName(periodId, name) {
            const period = periods.find(p => p.id === periodId);
            if (period) {
                period.name = name;
            }
        }

        // 更新时段日期
        function updatePeriodDate(periodId, type, date) {
            const period = periods.find(p => p.id === periodId);
            if (period) {
                if (type === 'start') {
                    period.startDate = date;
                } else {
                    period.endDate = date;
                }
            }
        }

        // 删除时段
        function removePeriod(periodId) {
            periods = periods.filter(p => p.id !== periodId);
            renderPeriodList();
        }

        // 获取周数标识
        function getWeekIdentifier(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const startOfYear = new Date(year, 0, 1);
            const dayOfYear = Math.ceil((d - startOfYear) / (1000 * 60 * 60 * 24));
            const weekNumber = Math.ceil(dayOfYear / 7);
            return `${year}-W${weekNumber}`;
        }

        // 生成演示数据（以星期为单位）
        function generateData(stationId, startDate, endDate, timeType = 'daily') {
            const data = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // 为不同站点生成略有差异的数据
            const stationOffset = parseInt(stationId.replace('station', '')) * 3;
            
            // 根据时间类型生成数据
            if (timeType === 'hourly') {
                // 生成小时数据（每小时一条记录）
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const weekday = d.getDay() === 0 ? 6 : d.getDay() - 1; // 转换为周一到周日
                    const weekId = getWeekIdentifier(dateStr);
                    const dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                    const seasonalFactor = Math.sin(dayOfYear / 365 * Math.PI * 2);
                    
                    // 为每个小时生成数据
                    for (let hour = 0; hour < 24; hour++) {
                        // 基于小时调整因子（例如：交通高峰期PM2.5更高）
                        const hourFactor = (hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19) ? 1.2 : 1.0;
                        
                        // 周末通常空气质量略好（工作日交通更多）
                        const weekdayFactor = weekday < 5 ? 1.1 : 0.95;
                        
                        data.push({
                            date: dateStr,
                            hour: hour,
                            weekday: weekday,
                            weekdayName: weekdays[weekday],
                            weekId: weekId,
                            // 根据用户要求调整各污染物的基准值和波动范围
                            // PM2.5调整在12±5之间波动
                            PM25: Math.max(0, Math.round(12 + (Math.random() - 0.5) * 10 + stationOffset)),
                            // PM10调整在10±10之间波动
                            PM10: Math.max(0, Math.round(10 + (Math.random() - 0.5) * 20 + stationOffset)),
                            // O3-8h调整在10±5之间波动
                            O3_8h: Math.max(0, Math.round(10 + (Math.random() - 0.5) * 10 + stationOffset)),
                            // NO2调整在1±1之间波动
                            NO2: Math.max(0, Math.round(1 + (Math.random() - 0.5) * 2 + stationOffset)),
                            // SO2固定为1
                            SO2: 1,
                            // CO调整在3±1之间波动
                            CO: Math.max(0, Math.round((3 + (Math.random() - 0.5) * 2) * 10) / 10 + stationOffset / 100),
                            AQI: 0
                        });
                    }
                }
            } else {
                // 生成日均值数据（每天一条记录）
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const weekday = d.getDay() === 0 ? 6 : d.getDay() - 1; // 转换为周一到周日
                    const weekId = getWeekIdentifier(dateStr);
                    const dayOfYear = Math.floor((d - new Date(d.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                    const seasonalFactor = Math.sin(dayOfYear / 365 * Math.PI * 2);
                    
                    // 周末通常空气质量略好（工作日交通更多）
                    const weekdayFactor = weekday < 5 ? 1.1 : 0.95;
                    
                    data.push({
                        date: dateStr,
                        weekday: weekday,
                        weekdayName: weekdays[weekday],
                        weekId: weekId,
                        // 根据用户要求调整各污染物的基准值和波动范围
                        // PM2.5调整在12±5之间波动
                        PM25: Math.max(0, Math.round(12 + (Math.random() - 0.5) * 10 + stationOffset)),
                        // PM10调整在10±10之间波动
                        PM10: Math.max(0, Math.round(10 + (Math.random() - 0.5) * 20 + stationOffset)),
                        // O3-8h调整在10±5之间波动
                        O3_8h: Math.max(0, Math.round(10 + (Math.random() - 0.5) * 10 + stationOffset)),
                        // NO2调整在1±1之间波动
                        NO2: Math.max(0, Math.round(1 + (Math.random() - 0.5) * 2 + stationOffset)),
                        // SO2固定为1
                        SO2: 1,
                        // CO调整在3±1之间波动
                        CO: Math.max(0, Math.round((3 + (Math.random() - 0.5) * 2) * 10) / 10 + stationOffset / 100),
                        AQI: 0
                    });
                }
            }
            
            // 计算AQI
            data.forEach(item => {
                const aqi = Math.max(
                    calculateAQI(item.PM25, 'PM25'),
                    calculateAQI(item.PM10, 'PM10'),
                    calculateAQI(item.O3_8h, 'O3'),
                    calculateAQI(item.NO2, 'NO2'),
                    calculateAQI(item.SO2, 'SO2'),
                    calculateAQI(item.CO, 'CO')
                );
                item.AQI = Math.round(aqi);
            });
            
            return data;
        }

        function calculateAQI(value, type) {
            const breakpoints = {
                PM25: [[0,50,0,35],[50,100,35,75],[100,150,75,115],[150,200,115,150],[200,300,150,250],[300,500,250,500]],
                PM10: [[0,50,0,50],[50,100,50,150],[100,150,150,250],[150,200,250,350],[200,300,350,420],[300,500,420,600]],
                O3: [[0,50,0,100],[50,100,100,160],[100,150,160,215],[150,200,215,265],[200,300,265,800],[300,500,800,1200]],
                NO2: [[0,50,0,40],[50,100,40,80],[100,150,80,180],[150,200,180,280],[200,300,280,565],[300,500,565,750]],
                SO2: [[0,50,0,50],[50,100,50,150],[100,150,150,475],[150,200,475,800],[200,300,800,1600],[300,500,1600,2620]],
                CO: [[0,50,0,2],[50,100,2,4],[100,150,4,14],[150,200,14,24],[200,300,24,36],[300,500,36,60]]
            };
            
            const bp = breakpoints[type] || breakpoints.PM25;
            for (let i = 0; i < bp.length; i++) {
                if (value >= bp[i][0] && value <= bp[i][1]) {
                    const aqi = ((bp[i][3] - bp[i][2]) / (bp[i][1] - bp[i][0])) * (value - bp[i][0]) + bp[i][2];
                    return aqi;
                }
            }
            return 0;
        }

        function analyze() {
            const analysisMode = document.getElementById('analysisMode').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const timeType = document.getElementById('timeType').value;
            
            allData = {};
            
            if (analysisMode === 'multiStation') {
                selectedStations.forEach(stationId => {
                    allData[stationId] = generateData(stationId, startDate, endDate, timeType);
                });
            } else {
                // 多时段分析
                if (periods.length === 0) {
                    alert('请至少添加一个时段');
                    return;
                }
                periods.forEach(period => {
                    allData[period.id] = generateData('station1', period.startDate, period.endDate, timeType);
                });
            }
            
            updateChart();
            updateDataTable();
        }

        function updateChart() {
            const ctx = document.getElementById('weekdayChart');
            
            if (weekdayChart) {
                weekdayChart.destroy();
            }
            
            const analysisMode = document.getElementById('analysisMode').value;
            const timeType = document.getElementById('timeType').value;
            
            const datasets = [];
            let labelList = [];
            
            // 按周数聚合数据，而不是按星期几聚合
            // 首先收集所有数据中的周数标识
            const weekIds = new Set();
            Object.keys(allData).forEach(key => {
                allData[key].forEach(item => {
                    if (item.weekId) {
                        weekIds.add(item.weekId);
                    }
                });
            });
            
            // 将周数标识转换为有序数组
            const sortedWeekIds = Array.from(weekIds).sort();
            
            // 创建周数数据结构
            const weekData = {};
            sortedWeekIds.forEach(weekId => {
                weekData[weekId] = {};
                selectedPollutants.forEach(pollutant => {
                    weekData[weekId][pollutant] = [];
                });
            });
            
            // 填充数据
            Object.keys(allData).forEach(key => {
                allData[key].forEach(item => {
                    if (item.weekId && weekData[item.weekId]) {
                        selectedPollutants.forEach(pollutant => {
                            weekData[item.weekId][pollutant].push(parseFloat(item[pollutant]) || 0);
                        });
                    }
                });
            });
            
            // 生成数据集
            if (analysisMode === 'multiStation') {
                // 多站点模式：每个站点一条线
                stations.forEach((station, stationIdx) => {
                    if (selectedStations.includes(station.id)) {
                        selectedPollutants.forEach(pollutant => {
                            const values = sortedWeekIds.map(weekId => {
                                const values = weekData[weekId][pollutant];
                                return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                            });
                            
                            datasets.push({
                                label: `${station.name} - ${pollutants.find(p => p.id === pollutant).name}`,
                                data: values,
                                borderColor: `hsl(${(stationIdx * 60) % 360}, 70%, 50%)`,
                                backgroundColor: `hsla(${(stationIdx * 60) % 360}, 70%, 50%, 0.1)`,
                                tension: 0.4,
                                fill: false
                            });
                        });
                    }
                });
            } else {
                // 多时段模式：每个时段一条线
                periods.forEach((period, periodIdx) => {
                    selectedPollutants.forEach(pollutant => {
                        const values = sortedWeekIds.map(weekId => {
                            const values = weekData[weekId][pollutant];
                            return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                        });
                        
                        datasets.push({
                            label: `${period.name} - ${pollutants.find(p => p.id === pollutant).name}`,
                            data: values,
                            borderColor: `hsl(${(periodIdx * 60) % 360}, 70%, 50%)`,
                            backgroundColor: `hsla(${(periodIdx * 60) % 360}, 70%, 50%, 0.1)`,
                            tension: 0.4,
                            fill: false
                        });
                    });
                });
            }
            
            // 将周数标识转换为"第N周"格式的标签
            labelList = sortedWeekIds.map((weekId, index) => `第${index + 1}周`);
            
            weekdayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelList,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    height: 400,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '浓度值' }
                        },
                        x: {
                            title: { 
                                display: true, 
                                text: '周数'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                maxHeight: 100,
                                overflow: 'auto'
                            }
                        }
                    }
                }
            });
        }

        // 分页相关变量
        let currentPage = 1;
        const pageSize = 15;
        let allTableData = [];
        
        // 更新数据表格（带分页）
        function updateDataTable() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            const analysisMode = document.getElementById('analysisMode').value;
            const timeType = document.getElementById('timeType').value;
            
            // 创建表头
        const theadRow = document.createElement('tr');
        const headerCell = document.createElement('th');
        headerCell.textContent = timeType === 'hourly' ? '小时' : '星期';
        theadRow.appendChild(headerCell);
            
            // 添加各指标列头
            if (analysisMode === 'multiStation') {
                selectedStations.forEach(stationId => {
                    const station = stations.find(s => s.id === stationId);
                    selectedPollutants.forEach(pollutantId => {
                        const pollutant = pollutants.find(p => p.id === pollutantId);
                        const th = document.createElement('th');
                        th.textContent = `${station.name}-${pollutant.name}`;
                        theadRow.appendChild(th);
                    });
                });
            } else {
                periods.forEach(period => {
                    selectedPollutants.forEach(pollutantId => {
                        const pollutant = pollutants.find(p => p.id === pollutantId);
                        const th = document.createElement('th');
                        th.textContent = `${period.name}-${pollutant.name}`;
                        theadRow.appendChild(th);
                    });
                });
            }
            
            tableHead.appendChild(theadRow);
            
            // 计算所有数据
            allTableData = [];
            
            if (timeType === 'hourly') {
                // 按小时聚合数据
                const hourlyData = {};
                
                // 初始化小时数据（0-23小时）
                for (let hour = 0; hour < 24; hour++) {
                    hourlyData[hour] = {};
                    Object.keys(allData).forEach(key => {
                        hourlyData[hour][key] = {};
                        selectedPollutants.forEach(pollutant => {
                            hourlyData[hour][key][pollutant] = 0;
                        });
                    });
                }
                
                // 填充和计算数据
                Object.keys(allData).forEach(key => {
                    allData[key].forEach(item => {
                        if (item.hour !== undefined) {
                            selectedPollutants.forEach(pollutant => {
                                const values = allData[key].filter(d => d.hour === item.hour).map(d => parseFloat(d[pollutant]) || 0);
                                if (values.length > 0) {
                                    hourlyData[item.hour][key][pollutant] = values.reduce((a, b) => a + b, 0) / values.length;
                                }
                            });
                        }
                    });
                });
                
                // 保存完整数据
                for (let hour = 0; hour < 24; hour++) {
                    allTableData.push({
                        id: `${hour}时`,
                        data: hourlyData[hour]
                    });
                }
            } else {
                // 按周数聚合数据
                // 首先收集所有数据中的周数标识
                const weekIds = new Set();
                Object.keys(allData).forEach(key => {
                    allData[key].forEach(item => {
                        if (item.weekId) {
                            weekIds.add(item.weekId);
                        }
                    });
                });
                
                // 将周数标识转换为有序数组
                const sortedWeekIds = Array.from(weekIds).sort();
                
                // 创建周数数据结构
                const weekData = {};
                sortedWeekIds.forEach(weekId => {
                    weekData[weekId] = {};
                    Object.keys(allData).forEach(key => {
                        weekData[weekId][key] = {};
                        selectedPollutants.forEach(pollutant => {
                            weekData[weekId][key][pollutant] = 0;
                        });
                    });
                });
                
                // 填充和计算数据
                sortedWeekIds.forEach((weekId, index) => {
                    Object.keys(allData).forEach(key => {
                        const weekItems = allData[key].filter(item => item.weekId === weekId);
                        selectedPollutants.forEach(pollutant => {
                            const values = weekItems.map(item => parseFloat(item[pollutant]) || 0);
                            if (values.length > 0) {
                                weekData[weekId][key][pollutant] = values.reduce((a, b) => a + b, 0) / values.length;
                            }
                        });
                    });
                    
                    // 保存完整数据
                    allTableData.push({
                        id: `第${index + 1}周`,
                        data: weekData[weekId]
                    });
                });
            }
            
            // 重置当前页码
            currentPage = 1;
            
            // 渲染分页数据
            renderPage(currentPage);
        }
        
        // 渲染指定页的数据
        function renderPage(page) {
            const tableBody = document.getElementById('tableBody');
            const analysisMode = document.getElementById('analysisMode').value;
            
            tableBody.innerHTML = '';
            
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = allTableData.slice(startIndex, endIndex);
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = item.id;
                row.appendChild(cell);
                
                if (analysisMode === 'multiStation') {
                    selectedStations.forEach(stationId => {
                        selectedPollutants.forEach(pollutantId => {
                            const td = document.createElement('td');
                            td.textContent = item.data[stationId]?.[pollutantId]?.toFixed(2) || '0.00';
                            row.appendChild(td);
                        });
                    });
                } else {
                    periods.forEach(period => {
                        selectedPollutants.forEach(pollutantId => {
                            const td = document.createElement('td');
                            td.textContent = item.data[period.id]?.[pollutantId]?.toFixed(2) || '0.00';
                            row.appendChild(td);
                        });
                    });
                }
                
                tableBody.appendChild(row);
            });
            
            // 更新分页控件
            updatePagination();
        }
        
        // 更新分页控件
        function updatePagination() {
            const pagination = document.getElementById('dataTablePagination');
            const totalPages = Math.ceil(allTableData.length / pageSize);
            
            pagination.innerHTML = '';
            
            // 上一页按钮
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '上一页';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    renderPage(--currentPage);
                }
            };
            pagination.appendChild(prevBtn);
            
            // 页码信息
            const pageInfo = document.createElement('span');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            pagination.appendChild(pageInfo);
            
            // 下一页按钮
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '下一页';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    renderPage(++currentPage);
                }
            };
            pagination.appendChild(nextBtn);
        }
        
        // 时间轴相关功能

        
        // 退出登录功能
        function logout() {
            // 模拟退出登录
            alert('已退出登录');
            window.location.href = 'login.html';
        }

        function exportImage() {
            if (weekdayChart) {
                const url = weekdayChart.toBase64Image();
                const link = document.createElement('a');
                link.download = '污染物星期分析结果.png';
                link.href = url;
                link.click();
            }
        }

        function exportCSV() {
            const analysisMode = document.getElementById('analysisMode').value;
            // x轴标题始终为周数，因为图表数据始终按周数聚合
            const xAxisTitle = '周数';
            
            // 添加表头
            if (analysisMode === 'multiStation') {
                selectedStations.forEach(stationId => {
                    const station = stations.find(s => s.id === stationId);
                    selectedPollutants.forEach(pollutantId => {
                        const pollutant = pollutants.find(p => p.id === pollutantId);
                        csv += `,${station.name}-${pollutant.name}`;
                    });
                });
            } else {
                periods.forEach(period => {
                    selectedPollutants.forEach(pollutantId => {
                        const pollutant = pollutants.find(p => p.id === pollutantId);
                        csv += `,${period.name}-${pollutant.name}`;
                    });
                });
            }
            csv += '\n';
            
            // 计算数据并添加行
            if (timeType === 'hourly') {
                // 按小时聚合数据
                const hourlyData = {};
                
                // 初始化小时数据（0-23小时）
                for (let hour = 0; hour < 24; hour++) {
                    hourlyData[hour] = {};
                    Object.keys(allData).forEach(key => {
                        hourlyData[hour][key] = {};
                        selectedPollutants.forEach(pollutant => {
                            hourlyData[hour][key][pollutant] = 0;
                        });
                    });
                }
                
                // 填充和计算数据
                Object.keys(allData).forEach(key => {
                    allData[key].forEach(item => {
                        if (item.hour !== undefined) {
                            selectedPollutants.forEach(pollutant => {
                                const values = allData[key].filter(d => d.hour === item.hour).map(d => parseFloat(d[pollutant]) || 0);
                                if (values.length > 0) {
                                    hourlyData[item.hour][key][pollutant] = values.reduce((a, b) => a + b, 0) / values.length;
                                }
                            });
                        }
                    });
                });
                
                // 添加数据行
                for (let hour = 0; hour < 24; hour++) {
                    csv += `${hour}时`;
                    if (analysisMode === 'multiStation') {
                        selectedStations.forEach(stationId => {
                            selectedPollutants.forEach(pollutantId => {
                                csv += `,${hourlyData[hour][stationId]?.[pollutantId]?.toFixed(2) || '0.00'}`;
                            });
                        });
                    } else {
                        periods.forEach(period => {
                            selectedPollutants.forEach(pollutantId => {
                                csv += `,${hourlyData[hour][period.id]?.[pollutantId]?.toFixed(2) || '0.00'}`;
                            });
                        });
                    }
                    csv += '\n';
                }
            } else {
                // 按周数聚合数据
                // 首先收集所有数据中的周数标识
                const weekIds = new Set();
                Object.keys(allData).forEach(key => {
                    allData[key].forEach(item => {
                        if (item.weekId) {
                            weekIds.add(item.weekId);
                        }
                    });
                });
                
                // 将周数标识转换为有序数组
                const sortedWeekIds = Array.from(weekIds).sort();
                
                // 创建周数数据结构
                const weekData = {};
                sortedWeekIds.forEach(weekId => {
                    weekData[weekId] = {};
                    Object.keys(allData).forEach(key => {
                        weekData[weekId][key] = {};
                        selectedPollutants.forEach(pollutant => {
                            weekData[weekId][key][pollutant] = 0;
                        });
                    });
                });
                
                // 填充和计算数据
                sortedWeekIds.forEach((weekId, index) => {
                    Object.keys(allData).forEach(key => {
                        const weekItems = allData[key].filter(item => item.weekId === weekId);
                        selectedPollutants.forEach(pollutant => {
                            const values = weekItems.map(item => parseFloat(item[pollutant]) || 0);
                            if (values.length > 0) {
                                weekData[weekId][key][pollutant] = values.reduce((a, b) => a + b, 0) / values.length;
                            }
                        });
                    });
                });
                
                // 添加数据行
                sortedWeekIds.forEach((weekId, index) => {
                    csv += `第${index + 1}周`;
                    if (analysisMode === 'multiStation') {
                        selectedStations.forEach(stationId => {
                            selectedPollutants.forEach(pollutantId => {
                                csv += `,${weekData[weekId][stationId]?.[pollutantId]?.toFixed(2) || '0.00'}`;
                            });
                        });
                    } else {
                        periods.forEach(period => {
                            selectedPollutants.forEach(pollutantId => {
                                csv += `,${weekData[weekId][period.id]?.[pollutantId]?.toFixed(2) || '0.00'}`;
                            });
                        });
                    }
                    csv += '\n';
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '污染物星期分析结果.csv';
            link.click();
        }

        // 初始化
        window.onload = function() {
            initStationSelector();
            initPollutantSelector();
            onAnalysisModeChange();
            // 添加默认时段（用于多时段模式）
            addPeriod();
            
            // 默认执行查询分析
            analyze();
            
            // 初始化用户菜单显示
            const userMenu = document.getElementById('userMenu');
            if (userMenu) {
                // 可以在这里添加用户信息初始化逻辑
            }
        };
    </script>
</body>
</html>

